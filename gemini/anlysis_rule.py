# prompt_extract_score = """
# 你是一个专业的麻将游戏分析专家。
# 请仔细观看这个麻将游戏的结算截图，详细分析出：
# 该游戏的具体玩法规则，以及结算的计分规则。
# 返回标准的JSON格式数据。

# 如果有获胜玩家，请通过结算界面识别出胜利玩家的胡牌牌型以及对应的倍数（不是番数），例如：平胡 X1，填入对应的 `胡牌类型` 字段，只可以是以下列出的牌型名称。
# 如果没有完结获胜，则填入流局即可。

# 胡牌牌型的名词解释和定义，胡牌类型只可以是以下列出的牌型名称：
# 一、 基本/复合牌型
# 平胡: 由四个顺子（例如123万）或刻子（例如444筒）和一个对子（例如99筒）组成的标准胡牌结构。
# 碰碰胡: 由四个刻子（例如111万, 222筒, 333条, 888万）和一个对子（例如东东）组成的胡牌结构，牌中不含任何顺子。
# 七小对: 由七个独立的对子（例如11万, 22万, 33万...）组成的胡牌结构，不含任何顺子或刻子。
# 豪华七小对: 在七小对结构中，包含一组四张相同牌（例如2222万）和五个独立的对子。
# 双豪华七小对: 在七小对结构中，包含两组四张相同牌（例如2222万, 4444筒）和三个独立的对子。
# 三豪华七小对: 在七小对结构中，包含三组四张相同牌（例如2222万, 4444筒, 6666条）和一个独立的对子。
# 清一色: 胡牌时，手牌中所有14张牌均由同一花色（万、筒、或条）组成，不含字牌。
# 混一色: 胡牌时，手牌由单一花色（万、筒、或条）的牌和字牌（风牌、箭牌）组成，不含其他花色的牌。
# 清一色碰碰胡: 牌型既是“清一色”，又是“碰碰胡”。所有牌为同一花色，且结构为四个刻子加一对子。
# 混一色碰碰胡: 牌型既是“混一色”，又是“碰碰胡”。所有牌为同一花色和字牌，且结构为四个刻子加一对子。
# 混幺九: 牌型中所有顺子、刻子、对子仅由牌面为“1”或“9”的数牌和字牌组成。
# 清幺九: 牌型中所有顺子、刻子、对子仅由牌面为“1”或“9”的数牌组成，不含任何字牌。
# 将对: 牌型为“碰碰胡”，且所有刻子和对子仅由牌面为“2”、“5”、“8”的数牌组成。
# 中张（无1和9）: 牌型中所有牌仅由牌面为“2”至“8”的数牌组成，不含1、9和任何字牌。

# 二、 字牌特殊牌型（风牌、箭牌）
# 小三元: 牌型中包含两种箭牌（中、发、白）的刻子/杠，和剩下的另一种箭牌作对子（将牌）。
# 大三元: 牌型中包含所有三种箭牌（中、发、白）的刻子/杠，外加任意一个对子和任意一个刻子/顺子。
# 小四喜: 牌型中包含三种风牌（东、南、西、北）的刻子/杠，和剩下的第四种风牌作对子（将牌）。
# 大四喜: 牌型中包含所有四种风牌（东、南、西、北）的刻子/杠，外加任意一个对子（将牌）。
# 十三幺: 牌型由所有幺九牌（1、9的万筒条）和所有字牌（东南西北中发白）各一张，外加其中任意一张作为将牌（对子）组成。

# 三、 特殊牌张/数量牌型
# 十八罗汉: 牌型中包含四组杠（明杠或暗杠），外加一个对子。
# 一条龙: 牌型中包含同一花色从1到9的数字牌组成的三个顺子（123, 456, 789）。
# 全球人: 玩家通过吃、碰、杠，使得落地牌（面子）累计达到12张，手中只剩下一张单张牌，通过自摸或点炮胡这张单张牌（单吊）。

# 四、 特殊胡牌方式（倍数与动作相关）
# 天胡: 庄家（东家）在起手拿到14张牌后，无需摸牌即达成胡牌。
# 地胡: 非庄家玩家在第一巡内（庄家打出第一张牌后）通过自摸达成胡牌，期间未发生吃、碰、杠。
# 人胡: 第一巡内，玩家通过直杠或暗杠后摸牌达成胡牌。
# 抢杠胡: 其他玩家宣布补明杠时，正好胡这张补杠的牌。
# 杠上开花: 玩家通过杠牌（直杠、补杠、暗杠）后，摸取牌墙顶部的补牌（杠牌）达成自摸胡牌。
# 海底捞月: 玩家摸到牌墙中的最后一张牌达成自摸胡牌。
# 门清: 玩家在胡牌前，手牌没有经过任何吃、碰、明杠的操作。
# 卡五星: 玩家以一张数牌5作为胡牌张，形成一个456的顺子中的“卡张”胡法（例如胡5筒，卡在4筒和6筒之间）。
# 一炮多响: 玩家打出的点炮牌导致多个其他玩家同时胡牌。

# 五、 鬼牌/百搭牌相关（假设鬼牌为“中”）
# 无鬼胡: 胡牌时手牌中不包含任何“鬼牌”/“百搭牌”，且为自摸胡牌。
# 四鬼胡: 手牌中拥有四张“鬼牌”/“百搭牌”时，直接宣告胡牌（特殊规则）。
# 三金到: 庄家或闲家起手拿到的14张牌中，包含三张“鬼牌”/“百搭牌”时，直接宣告胡牌（特殊规则）。
# 鬼归位: 胡牌时，所有鬼牌/百搭牌都作为它们原始的牌面参与组成顺子、刻子或对子，没有作为其他牌型替代。
# 鬼吊: 玩家的手牌结构已构成一个听牌状态，且只需一张“鬼牌”即可听多张牌胡牌。
# 飞鬼（漂财，金）: 在“鬼吊”听牌情况下，打出一张鬼牌，但仍能维持鬼吊状态（听多张牌胡牌）。打出两张鬼牌为X4。

# 另外，请注意分析头像上的庄家信息，将其写入番型统计字段，如："{庄家，2连庄}，必须包含庄家信息"
# """

prompt_score_rule = """
泉州麻将分数结算规则如下：
一 番数计算：
金牌1番
花牌1番
暗刻1番
字牌暗刻2番
字牌碰牌1番
明杠2番
字牌明杠3番
暗杠3番
字牌暗杠4番
春夏秋冬8番
梅兰竹菊8番
八花齐16番
以上的番数，金牌，花牌，刻子，杠子，花色番型均可累加。例如：有两个金牌则为2番，三个花牌则为3番，以此类推。

二 底分规则：
闲家底分固定为5分，庄家底分默认为10分。
庄家连庄时，底分在原有基础上增加5分，公式为：庄家底分 = 10 + (连庄数 - 1) × 5
例如：1连庄时，庄家底分为10分；2连庄时，庄家底分为15分；3连庄时，庄家底分为20分，以此类推。

三 胡牌公式：
赢牌玩家的总番数 = (底分 + 单项番数) x 胡牌倍数
赢牌玩家得分 = 赢牌玩家的总番数 × 3（玩家数量)

胡牌倍数清单：
平胡倍数 1倍
自摸倍数 2倍
抢杠胡倍数 2倍
三金倒倍数 3倍
天胡倍数 4倍
天听倍数 4倍
游金倍数 4倍
双游倍数 8倍
三游倍数 16倍

四 庄家输时额外的结算规则：
庄家输牌时，（庄家底分-赢家底分）x 胡牌倍数，庄家和赢家单独进行额外结算。

五 输家之间番数额外结算：
赢家不参与该部分结算。
输家在和赢家结算之后，还需根据输家各自的番数进行额外结算：
输家之间的番数相减，按每番底分1分进行互相结算。
例如：玩家A为5番，玩家B为3番，则玩家B需向玩家A支付(5-3)*1=2分。

六 课玩法：
每个玩家初始分数为100分，如果结算时有玩家低于等于0分即出局，游戏结束，否则继续进行下一局游戏。
结算时如果玩家分数不足以支付输分，则只需要支付该玩家剩余的分数即可。
如果出现玩家出局的情况，则该局结算该玩家不进行输家之间番数额外结算。

注意事项：
1. 庄家不等于赢家，通常是第一个玩家并且分数是正数的玩家。
2. 庄家输牌时，才会触发庄家输时额外的结算规则。

请根据以上规则，分析提供的 JSON 结构化数据文件。
筛选出与该规则不匹配的数据出来。需要验证：
1. 番数计算是否正确，是否符合上述番数计算规则。
2. 最后得分是否符合胡牌公式和倍数规则。
3. 验证时如果发现不匹配的数据，判断是否可能是因为触发了课玩法，并在分析中标记出来。

给出你的分析规则和验证的步骤说明即可，不需要逐局分析复盘，只需要分析不匹配的数据和其原因。
"""

prompt_analyze_score = """
你是“泉州麻将”结算单的结构化信息抽取助手。输入是一张结算截图，请严格按以下要求提取并输出 JSON：

目标数据结构（仅用于说明，实际输出请只给 JSON）：
{
  "玩家分数数据": [
    {
      "玩家名字": "字符串，左侧头像下方昵称",
      "番数列表": [
        {"名称": "番型名称", "番数": 1}
      ],
      "胡牌信息": {"名称": "自摸/抢杠胡/平胡/…", "倍数": 2},
      "总番数": 20,
      "庄家": true,
      "连庄数": 2,
      "底分": 15,
      "分数变化": 90
    }
  ]
}

抽取与计算规范：
1) 识别玩家与分数
- 玩家顺序：按界面从上到下四位玩家。
- 玩家名字：读取头像旁/下方的昵称文本。
- 分数变化：读取每行右侧最终分数字样（如“+90”“-17”），转为整数，正负号保留。

2) 识别总番（右侧“X番”）
- 每名玩家行尾都有“X番”，解析为整数。该值是“(底分+单项番数)×胡牌倍数”的结果番数，命名为“总番数”。

3) 识别胡牌信息与倍数
- 若某行存在红色/标签样式的“自摸x2/抢杠胡x2/三金倒x3/天胡x4/游金x4/双游x8/三游x16”等，提取为：
  胡牌信息.名称 = 标签中的文字（不含“xN”）
  胡牌信息.倍数 = 标签中的 N
- 若未见到倍数标签但该玩家为和牌方，则根据界面其它提示或默认为“平胡 x1”。
- 非和牌玩家：胡牌信息名称为“未胡”，倍数为1。

4) 识别单项番型（番数列表）
- 从每行左侧说明文字中，逐段解析形如“金牌1番/花牌2番/刻子3番/字牌暗刻2番/明杠2番/字牌明杠3番/暗杠3番/字牌暗杠4番/春夏秋冬8番/梅兰竹菊8番/八花齐16番”等。
- 名称为番型名（例如“花牌”“明杠”“字牌暗刻”“刻子”），番数取其后的数字。
- 若同名多段，合并为一条并将番数相加。
- 没有显示的番型不要臆造；若完全无该行说明则给空数组 []。

5) 识别庄家与连庄数、底分
- 庄家判定优先依据头像上的“庄”标记，有该标签者通常为庄家。
- 四个玩家中有且只有一个玩家是庄家。
- 连庄数：读取头像旁“X”的数字；未显示则填 1。
- 底分：按规则填写
  - 庄家：10 + (连庄数-1)*5
  - 闲家：5

6) 一致性
- 若界面“总番数（X番）”与根据“(底分 + sum(番数列表)) × 胡牌信息.倍数”计算不一致，以界面“X番”为准写入“总番数”字段。
- 分数变化为界面最终数值，不需再计算。

7) 输出
- 仅输出 JSON，且必须严格符合下述键名与类型：
  - 玩家分数数据: 数组
  - 玩家名字: 字符串
  - 番数列表: 数组，元素为 {名称: 字符串, 番数: 整数}
  - 胡牌信息: 对象 {名称: 字符串, 倍数: 整数}
  - 总番数: 整数
  - 庄家: 布尔
  - 连庄数: 整数
  - 底分: 整数
  - 分数变化: 整数

8) 兜底策略
- 无法识别的字段使用最合理推断；确实无法判断时：
  - 番数列表 = []
  - 胡牌信息 = {"名称": "未胡", "倍数": 1}
  - 总番数 = 0
  - 庄家 = false（但若能确定某一位是庄家则仅该位为 true）
  - 连庄数 = 1
  - 底分 = 5（若为庄家则按规则）
  - 分数变化 = 来自界面显示（若缺失则 0）

严格只输出 JSON，不要包含多余说明、注释或代码块标记。
"""